<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>Mobiquity Challenge</title>
  <link rel="shortcut icon" href="http://d29vcfpn0e63gd.cloudfront.net/sites/all/themes/mobiquity/favicon.ico"
        type="image/vnd.microsoft.icon"/>
  <link rel="stylesheet" type="text/css"
        href="http://fonts.googleapis.com/css?family=Droid+Sans">
  <style type="text/css">

  body {
    background-color: #f9f9f9;
    font-family:'Droid Sans' ;
    box-sizing: border-box;
  }

    .w90{
      width:90%;

    }

    .centered{
      margin:0 auto;
    }

    ol.calendar-items li.calendar-item{
      padding:1%;
      display:block;
      float:left;
      list-style-type: none;
      outline:1px dashed blue;

    }

    div.w50{

      width:50%;
      padding:1%;
    }

    .left{
      float:left;
    }
    .right{
      float:right;
    }

    .clearfix{
      clear:both;
      display:table-cell;
      width:100%;
    }

    .outline{
      outline:1px silver dashed;
    }

  </style>
  <script src="http://code.angularjs.org/1.3.3/angular.js"></script>
  <script src="http://code.angularjs.org/1.3.3/angular-route.min.js"></script>

  <script>
    (function(undefined) {

      var exists = function(value){
        return typeof value !== "undefined";
      }

      var empty = function(arr){
        console.log(arr);
        return typeof arr === "Array" && arr.length < 1;
      }



      var google_module = angular.module('Google',[]);

      google_module.service('GoogleAuth',function($location,$http){

        var access_token = null;
        var client_id = '682690953089-pcokcr123r9m8v602p0rv9bi9vkfcsc0.apps.googleusercontent.com';
        var obj = {
          ajaxing: false, //are we doing something?
          parseGoogleAuthTokenFromCurrentLocation: function () {
            //lifted straight from google, will refactor if I have time
            var queryString = location.hash.substring(1),
              regex = /([^&=]+)=([^&]*)/g, m;
            while (m = regex.exec(queryString)) {
              if (m[1] == "access_token") {
                access_token = decodeURIComponent(m[2]);
              }
            }

            console.log('the access_token is:', access_token);


          },
          getClientID: function () {
            return client_id;
          },
          getAccessToken:function(){
            return access_token;
          }
        }
        return obj;

      });

      google_module.service('GoogleCalendar', function ($location, $http,GoogleAuth,$q) {


        return {
          getAuthHeaderData: function () {
            return {'Authorization': 'Bearer ' + GoogleAuth.getAccessToken()}

          },
          getList: function () {
            var deferred = $q.defer();
            if(!GoogleAuth.getAccessToken()){
              deferred.resolve([]);
              return deferred.promise;
            }
            console.log('get list was called');
            $http({
              'method': 'GET',
              'url': 'https://www.googleapis.com/calendar/v3/users/me/calendarList',
              'headers': this.getAuthHeaderData()
            }).success(function (data) {
              //get ourselves a list we can populate a dropdown from
              var list = [];

              if(exists(data) && exists(data.items) && !empty(data.items)){
               deferred.resolve(data.items);
              }
            });
            return deferred.promise;
          },
          getListForCalendarId:function(id){

            var deferred = $q.defer();
            console.log('get list was called');
            $http({
              'method': 'GET',
              'url': 'https://www.googleapis.com/calendar/v3/calendars/' + id.toString() + '/events',
              'headers': this.getAuthHeaderData()
            }).success(function (data) {
              //get ourselves a list we can populate a dropdown from
              var list = [];

              if (exists(data) && exists(data.items) && !empty(data.items)) {
                deferred.resolve(data.items);
              }
            });
            return deferred.promise;

          }
        }
      });

      var application = angular.module('Mobiquity.googleCalendar', [
        'ngRoute','Google']);

      application.config(function($routeProvider,$locationProvider){
        $locationProvider.html5Mode({
          enabled: true,
          requireBase: false
        });
      });

      application.run(function () {

      });

      application.controller('MainController', function ($scope,GoogleAuth,GoogleCalendar,$location,$window) {
        $scope.google_auth = GoogleAuth;
        $scope.google_calendar = GoogleCalendar;

        $scope.calendar_id = null;

        $scope.calendars = [];
        $scope.calendar_events = [];

        $scope.dateChanged = function(){

        console.log("the date changed");
        }



        $scope.google_auth.parseGoogleAuthTokenFromCurrentLocation();


        $scope.getCalendarEvents = function(){


        }
        $scope.getCalendarList = function(){
          $scope.google_calendar.getList().then(function(data){
            $scope.calendars = data;
          });
        }

        $scope.getListForSelectedCalendar = function(){

          var encoded = encodeURIComponent($scope.calendar_id); //


          $scope.google_calendar.getListForCalendarId(encoded).then(function(data){
            $scope.calendar_events = data;
          });
        }

        $scope.$watch('google_auth.access_token',function(){
          $scope.getCalendarList(); //this could probably be named better.. like populate calendar list

        });


      });

    })(undefined); //no global namespace pollution

  </script>
</head>
<body ng-app="Mobiquity.googleCalendar" ng-controller="MainController">
<div class="w90 centered" style="outline:1px red solid;">




  <div class="w50 left outline"><h2>Auth</h2>
    <!-- I didn't want to break indent here, I know this is way too long-->
    <a ng-href="https://accounts.google.com/o/oauth2/auth?redirect_uri=http%3A%2F%2Fhonopu.com%2Fmobiquity&response_type=token&client_id={{google_auth.getClientID()}}&scope=email+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcalendar+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fcalendar&approval_prompt=force">Authorize</a>
  </div>
  <div class="w50 right outline">
    <form id="select-date">
      <div>
        <label for="">Choose Date: <input type="date" ng-model="selected_date" ng-change="dateChanged()"/></label>
        <input type="submit" value="Choose Date"/>
      </div>

    </form>
  </div>
  <div class="clearfix"></div>


  <select ng-model="calendar_id" ng-options="i.id as i.summary for i in calendars"
          ng-change="getListForSelectedCalendar()">
    <option value="">Please Choose A Calendar</option>
  </select>

  <ol class="calendar-items">
    <li class="calendar-item" ng-repeat="event in calendar_events">{{event | json }}</li>
  </ol>
</div>

</div>
</body>
</html>